# 4. Project Analysis and Concepts

This section presents an analysis of the Modula system, focusing on its functional and non-functional requirements, system users, and core operational workflows. The purpose of this section is to translate the project’s vision and architectural decisions into clearly defined system behaviors and quality attributes, ensuring that the proposed solution is feasible and aligned with real-world operational needs.

In Capstone II, Modula evolves from a prototype toward a production-oriented `/v0` system. As a result, this section emphasizes not only feature behavior (sales, inventory, staff operations) but also platform concerns required by real operations, such as multi-tenant structure, offline-first synchronization, idempotency under retries, and reliable cross-module execution patterns.

Scope note:
- This chapter specifies requirements and intended behavior. Implementation progress and figures are reported separately and are flagged when inputs are required.
- Advanced analytics and business intelligence remain out of scope for the Capstone II draft unless explicitly implemented and evaluated.

TODO_CAPSTONE2(FLAG-INT-01): clarify which requirements are fully integrated end-to-end in `/v0` vs implemented but not yet integrated.

---

## 4.1 Functional Requirements

This subsection defines the functional requirements of the Modula system, specifying the core behaviors the system must provide to support daily operations. Each requirement is written to be clear, testable, and aligned with the project scope.

The functional requirements are organized by operational domain for clarity and traceability.

---

### 4.1.1 User Authentication and Authorization

The system shall provide secure authentication and role-based authorization to control access to system features and data.

- The system shall allow users to create an account using a phone number and password.
- The system shall verify user identity using OTP during account registration and recovery flows.
- The system shall allow users to log in using a phone number and password after verification.
- The system shall support role-based access control with predefined roles (e.g., Admin, Manager, Cashier).
- The system shall restrict access to features and data based on the authenticated user’s role and selected tenant/branch context.
- The system shall allow a single user account to be associated with multiple tenants, enabling one user to operate across multiple businesses.
- The system shall maintain authenticated sessions to ensure continuity during active operations.

These requirements ensure security, accountability, and controlled access in a multi-user POS environment.

---

### 4.1.2 Sales and Order Processing

The system shall support end-to-end sales processing, from item selection to order fulfillment.

- The system shall allow authorized users to create sales by selecting menu items and applicable modifiers.
- The system shall support different sale types, including dine-in, take-away, and delivery.
- The system shall allow users to review and modify a cart before checkout (quantities, modifiers, discounts).
- The system shall calculate item-level subtotals, discounts, tax (VAT where applicable), and grand totals.
- The system shall support transactions in both USD and Khmer Riel (KHR), including clear display and rounding behavior.
- The system shall finalize sales into orders with defined lifecycle states such as in-prep, ready, served/delivered, void-pending, and voided.
- The system shall prevent unauthorized modification of finalized or voided sales while preserving a complete audit trail.

Optional operational mode (Capstone II design):
- The system shall support both **pay-first** and an optional **pay-later** workflow (open ticket), controlled by tenant policy.

TODO_CAPSTONE2(FLAG-INT-02): confirm which order lifecycle states are implemented in `/v0` and which remain specified only.

---

### 4.1.3 Inventory Management

The system shall provide inventory management capabilities to support stock visibility and control.

- The system shall allow administrators to create, update, archive, and restore stock items.
- The system shall allow stock items to exist without a category and be treated as uncategorized.
- The system shall maintain inventory quantities at the branch level.
- The system shall record all inventory changes using a journal-based approach to preserve a complete history of stock movements.
- The system shall support restocking and manual adjustments as controlled inventory movements.
- The system shall automatically deduct inventory quantities when a sale is finalized, subject to inventory policy and capability enablement.
- The system shall preserve historical inventory records even when items are archived.

---

### 4.1.4 Menu Management

The system shall support flexible configuration of menus used during sales operations.

- The system shall allow administrators to create, update, archive, and restore menu items.
- The system shall allow menu items to be organized into categories while permitting items without categories to remain uncategorized.
- The system shall allow administrators to create and manage modifier groups/options and assign them to menu items.
- The system shall support modifier-based price adjustments that contribute to final item price.
- The system shall allow menu items to be assigned to one or multiple branches and removed from branch availability without deletion.
- The system shall preserve historical sales data even when menu items are archived.

---

### 4.1.5 Cash Session and Cash Handling

The system shall support controlled cash handling through structured cash session management.

- The system shall allow authorized users to start and close cash sessions with recorded opening and closing cash amounts.
- The system shall associate cash-based sales with an active cash session when required by policy.
- The system shall support cash movements including paid-in, paid-out, and adjustments.
- The system shall calculate expected cash totals and cash variance upon session closure.

Approval and operation mode note (Capstone II design):
- In team operations, sensitive cash operations (e.g., refunds) may require managerial/administrative approval.
- In solo operations, the system must still preserve auditability and cash accountability while minimizing unnecessary approval loops.

TODO_CAPSTONE2(FLAG-PM-02): clarify which approval rules are included in Capstone II scope vs deferred.

---

### 4.1.6 Staff Attendance Management

The system shall support staff attendance tracking to record work sessions and support operational accountability.

- The system shall allow staff members to start and end work sessions based on branch context.
- The system shall prevent a staff member from having multiple active work sessions simultaneously.
- The system shall preserve attendance records as immutable historical data.
- The system shall allow administrators and managers to view attendance history for authorized scope.

Policy note (Capstone II baseline):
- Shift alignment and location verification may be captured as evidence/signals, but should not block work start/end by default.

---

### 4.1.7 Discount Management

The system shall support discount management to enable promotional pricing with predictable outcomes.

- The system shall allow administrators to create discount rules scoped to a branch.
- The system shall support discount types including percentage discounts and fixed-amount discounts.
- The system shall support item-level, category-level, and sale-level discount scopes.
- The system shall apply eligible discounts during sale calculation once configured.
- The system shall lock applied discounts into finalized sales to prevent retroactive modification.
- The system shall define deterministic stacking behavior for overlapping discounts.

---

### 4.1.8 Reporting and Records

The system shall provide basic reporting capabilities to support operational oversight.

- The system shall generate sales reports summarizing transactions within a selected time period.
- The system shall include pending void transactions in reports with appropriate status indicators.
- The system shall generate inventory views/reports reflecting current stock levels (where inventory capability is enabled).
- The system shall restrict reporting access to authorized roles.

---

### 4.1.9 Offline Operation and Synchronization

The system shall support offline-first operation to ensure business continuity during network disruptions without compromising backend integrity.

- The system shall allow selected operational actions to proceed while offline using locally cached data.
- The system shall queue offline actions locally as durable operations and synchronize them when connectivity is restored.
- The system shall ensure replay is idempotent to prevent duplication under retries.
- The system shall support authoritative pull/hydration so clients converge to server truth without per-module polling.
- The system shall revalidate authorization and operational prerequisites on synchronization.

---

### 4.1.10 Subscription, Entitlements, and Branch Activation (Capstone II)

The system shall support subscription-aware enablement of capabilities while keeping operational behavior deterministic and auditable.

- The system shall treat a branch as a billable workspace unit that requires paid activation.
- The system shall prevent unpaid operational branches from existing.
- The system shall gate optional capabilities (modules) at the branch scope:
  - enabled modules allow normal write operations,
  - disabled modules remain visible but are read-only, and
  - cross-module side effects into a disabled module must be skipped deterministically (without breaking sale validity).

TODO_CAPSTONE2(FLAG-PM-01): confirm when subscription/billing flows are expected to be demoable during Capstone II.

---

## 4.2 Non-Functional Requirements

This subsection defines non-functional requirements of Modula, focusing on quality attributes that determine how well the system performs its intended functions. These requirements are derived from the operational context of small and medium-sized businesses and technical constraints discovered during implementation.

### 4.2.1 Security

- The system shall enforce role-based access control to restrict sensitive actions.
- The system shall ensure authentication credentials are securely handled and never exposed in plaintext.
- The system shall prevent unauthorized modification of finalized transactional data (sales, cash movements, inventory journal, attendance).
- The system shall record critical actions in an audit log for traceability and accountability.

### 4.2.2 Performance

- The system shall support rapid item selection and checkout workflows to minimize customer wait times.
- The system shall perform core calculations (cart totals, discounts, tax) with minimal latency.
- The system shall support efficient synchronization (push replay and pull hydration) without blocking core UX unnecessarily.

### 4.2.3 Usability

- The system shall minimize manual decision-making during sales by automating calculations (discounts, tax, currency conversion).
- The system shall provide role-appropriate interfaces so users see features relevant to their responsibilities.
- The system shall support a responsive UI across small and wide screens for operational workflows.

### 4.2.4 Reliability

- The system shall preserve data integrity under unstable connectivity and retries.
- The system shall ensure critical ledgers (cash session movements, inventory journal) are durable and append-only where applicable.
- The system shall ensure idempotent write behavior under retries and offline replay.
- The system shall avoid inconsistent intermediate states by applying reliable cross-module execution patterns (e.g., outbox/eventual processing where used).
- The system shall preserve historical records even when entities are archived or access is revoked.

### 4.2.5 Portability

- The system shall be accessible through modern web browsers on phones, tablets, and computers.
- The system shall not require dedicated POS hardware to perform core operations by default.

### 4.2.6 Maintainability

- The system shall adopt a modular architecture separating core modules from feature modules.
- The system shall centralize cross-cutting concerns such as policy enforcement, idempotency, offline sync, and audit logging.
- The system shall limit inter-module coupling to clearly defined interfaces and contracts.

### 4.2.7 Scalability

- The system shall support multiple tenants within a single deployment.
- The system shall support expansion from single-branch to multi-branch operations.
- The system shall allow new feature modules and vertical capability upgrades without disrupting existing workflows.

---

## 4.3 System Users and Behavioral Modeling

This subsection analyzes the system from a user and behavioral perspective by identifying system actors and illustrating their interactions through use case and activity diagrams.

TODO_CAPSTONE2(FLAG-FIG-03): insert updated use case diagram figure(s) for Capstone II.

### 4.3.3 Activity Diagrams

Activity diagrams illustrate dynamic behavior of the Modula POS system from a user-oriented perspective. The diagrams included in this section focus on key workflows that represent core system behavior.

TODO_CAPSTONE2(FLAG-FIG-04): insert updated activity diagram figures for Capstone II (login/onboarding flow and sale/order creation flow).

---

## 4.3.3 Activity Diagrams (Textual Specification)

### Activity Diagram: User Authentication and Tenant Selection (Capstone II)

1. Start
2. User opens the application
3. Decision: user has an existing account?
   - No: user registers (profile fields + phone verification via OTP + password setup)
   - Yes: user logs in using phone number and password
4. System loads the user’s tenant memberships and pending invitations
5. Decision: user has at least one active membership?
   - Yes: user selects a tenant and proceeds
   - No: user views invitations (accept/reject) or creates a new tenant (if intended as business owner)
6. System resolves role and branch context for the selected tenant
7. Redirect user to role-appropriate portal/navigation shell
8. End

### Activity Diagram: Sale and Order Creation (Pay-First Baseline)

1. Start
2. Operator opens Sale module
3. Decision: is a cash session required by policy?
   - Yes: check for active cash session
     - If no active session: prompt user to start cash session
4. Operator adds menu items to cart
5. Operator selects sale type (dine-in, take-away, delivery)
6. System calculates subtotal, eligible discounts, tax, and grand total
7. Operator selects payment method
8. Operator confirms checkout
9. System finalizes sale
10. System creates order with status = in-prep
11. System generates receipt/eReceipt record
12. End

Optional extension (Capstone II design): Pay-later
- If pay-later is enabled, the system supports creating an open ticket/order without immediate payment finalization, and later settling it through checkout.

