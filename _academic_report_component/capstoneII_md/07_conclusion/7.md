# 7. Conclusion

This chapter summarizes the outcomes of Capstone II to date, highlights key challenges and lessons learned, and outlines remaining work for completion and post-capstone directions.

Because Capstone II is still in progress at the time of this first draft, this chapter distinguishes between:
- what has been implemented and is demonstrable,
- what is designed/spec-defined but not yet fully integrated,
- and what remains future work.

TODO_CAPSTONE2(FLAG-INT-01): confirm the exact list of end-to-end integrated `/v0` flows that are currently demoable.

---

## 7.1 Work Completed (Capstone II)

This section summarizes the modules and capabilities that were implemented or substantially advanced in Capstone II. “Completed” in this context means either (1) implemented and testable in the `/v0` codebase, or (2) finalized at the specification level with clear integration contracts, where implementation is ongoing.

### 7.1.1 Core / Platform Capabilities

Capstone II significantly strengthened the platform foundations required for a real-world POS system in Cambodia.

**Offline-first synchronization**

Compared to Capstone I, `/v0` formalizes offline-first as a dual-lane model (direct online feature endpoints plus offline replay) combined with authoritative pull hydration. This design makes the application resilient to unstable connectivity while keeping the backend authoritative for business invariants.

**Reliability under retries (duplicate-safe execution)**

Capstone II introduces explicit retry-safe command handling via stable intent identity (online: `Idempotency-Key`; offline: `clientOpId`) and deterministic conflict behavior when identities are reused with different payloads.

**Outbox-based event reliability**

To prevent “committed state but lost event” failure modes, `/v0` records outbox events transactionally with business writes and publishes them asynchronously with retry. This improves correctness for downstream effects (notifications, sync triggers, and other subscribers).

**Webhook ingestion and normalized dispatch**

Capstone II adopts a gateway approach for ingesting external webhook events and dispatching them into domain workflows in a normalized way, reducing vendor-specific coupling and improving auditability.

**Multi-tenant SaaS identity and membership model**

Capstone II aligns identity with multi-tenant SaaS expectations: accounts exist independently, tenants are joined via explicit invite/accept membership, and branch assignment is managed by tenant administrators. This addresses earlier contradictions where “staff accounts” were treated as provisioned entities rather than SaaS users.

**Subscription entitlements and branch monetization alignment**

Capstone II formalizes branch monetization as paid activation of a billable workspace (not reusable “slot capacity”). Module entitlements can gate write capabilities while keeping disabled modules visible as read-only for product discovery.

TODO_CAPSTONE2(FLAG-EVAL-01): summarize the evaluation performed so far for offline-first and retry safety (manual tests, integration checks, and observed results).

### 7.1.2 Feature Capabilities

Capstone II expands POS operational coverage and corrects limitations identified in the Capstone I prototype.

**Sales and orders**

Sales/order workflows are extended to support both pay-first operation and an optional pay-later policy (for restaurant-style “bill later” flows). This improves applicability beyond simple counter-service use cases.

**KHQR payment integration (design + integration contracts)**

Payment confirmation through KHQR introduces real-world constraints such as webhook delivery guarantees, offline operator workflows, and manual finalize pathways for unstable network conditions. Capstone II clarifies these behaviors as part of the sale finalization process.

TODO_CAPSTONE2(FLAG-INT-01): confirm current KHQR integration status (end-to-end vs partial) and what is deferred.

**Discount management**

Discount rules were refined to reflect practical administrator workflows, including branch-owned discount rules, lifecycle control (draft/inactive → activated), and deterministic overlap policy handling.

**Printing and peripherals (pilot scope)**

Capstone II explicitly considers receipt printing and kitchen printing as pilot requirements. The intended behavior is graceful degradation: printing is attempted when peripherals are connected, and failures do not block sales operations.

TODO_CAPSTONE2(FLAG-OPS-01): confirm pilot hardware details (receipt printer + kitchen sticker printer) and what is in/out of scope for Capstone II.

---

## 7.2 Difficulties

Capstone II faced challenges that reflect real-world software development beyond “prototype building”.

**Architecture refactoring from Capstone I prototype**

Capstone I prioritized rapid prototyping and code progress, which resulted in design smells and specification drift. Capstone II required coordinated refactoring across documentation, domain rules, and runtime architecture to restore consistency and correctness.

**Distributed-systems reality under offline-first**

Offline-first operation introduced non-trivial concerns: retries, duplicate execution prevention, eventual convergence, and deterministic conflict handling. These required formal contracts (push/pull sync interface), platform systems (outbox, job scheduling), and careful edge-case design.

**Cross-module alignment and blast radius**

Changes in identity/membership, monetization rules, and offline sync semantics created ripple effects across sales, workforce, reporting, and platform systems. Managing the blast radius required explicit tracking documents and iterative alignment with frontend/backend teams.

TODO_CAPSTONE2(FLAG-PM-02): add concrete examples of Capstone II scope tradeoffs and reprioritization decisions.

---

## 7.3 Lessons Learned

**Correctness and usability must be co-designed**

Several edge cases (e.g., pay-later settlement after shift change, offline confirmation, discount configuration overlap) demonstrate that “business rules” and “UX” cannot be separated cleanly. Correctness constraints must be designed together with operational workflows.

**A spec is a product, not a document**

The KB-driven process proved valuable: when the mod specs, processes, and edge-case sweeps were explicit, implementation became more predictable. Conversely, missing or ambiguous rules (identity/membership semantics, monetization terminology) quickly produced integration ambiguity.

**Hybrid architectures reduce migration risk**

Maintaining dual lanes (direct online feature endpoints plus offline replay) reduced migration risk while still achieving offline-first goals. This mirrors industry practice and allows gradual convergence toward stricter models later if required.

---

## 7.4 Perspectives (Remaining Work and Future Directions)

This section outlines what remains to complete Capstone II and what could follow beyond the academic scope.

### 7.4.1 Remaining Work for Capstone II Completion

- Complete FE↔BE integration for the critical `/v0` flows and validate end-to-end behavior.
- Finalize deployment choices that are still TBD (frontend hosting, OTP provider, CDN strategy).
- Validate pilot hardware workflows (receipt + kitchen printing) and ensure failure behavior is operationally safe.
- Perform and document evaluation (usability feedback, reliability tests for offline-first + retry safety).

TODO_CAPSTONE2(FLAG-PM-01): confirm the Capstone II milestone dates relevant to the pilot and final delivery.
TODO_CAPSTONE2(FLAG-OPS-03): confirm frontend hosting selection.
TODO_CAPSTONE2(FLAG-OPS-04): confirm OTP provider selection.
TODO_CAPSTONE2(FLAG-OPS-05): confirm CDN strategy for caching object storage assets.

### 7.4.2 Post-Capstone Functional Extensions

- Advanced analytics and business intelligence reporting (beyond operational reports).
- Deeper inventory automation (recipe-based deduction, vendor purchase workflows).
- Broader payment integrations and improved reconciliation tools.

### 7.4.3 Post-Capstone Security and Reliability

- Stronger abuse controls (rate limiting, anomaly detection).
- Expanded audit coverage and compliance exports.
- Production monitoring and incident response workflows.

### 7.4.4 Product and Platform Growth

- Expansion to additional industry bundles (e.g., retail vs F&B) with appropriate catalog and inventory scaling assumptions.
- Multi-device workflows per branch (terminals) and hardware identity, if required by future deployments.

