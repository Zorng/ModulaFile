# OperationalNotification — POS Operations In‑App Notifications (Baseline)

**Status:** Draft (locked baseline for Capstone 1)  
**Channel:** In‑app only (no email/SMS/push)  
**Intent:** Operational coordination signals (not policy, not marketing)

> Note: This root-level file is a **design artifact** captured during POSOperation work.
> The authoritative, layered BusinessLogic docs are now:
> - Story: `BusinessLogic/1_stories/correcting_mistakes/responding_to_operational_notifications.md`
> - Domain: `BusinessLogic/2_domain/60_PlatformSystems/operational_notification_domain.md`
> - Contract: `BusinessLogic/3_contract/10_edgecases/operational_notification_edge_case_sweep.md`
> - Process: `BusinessLogic/4_process/60_PlatformSystems/30_operational_notification_emission_process.md`
> - ModSpec: `BusinessLogic/5_modSpec/60_PlatformSystems/operationalNotification_module.md`

---

## 1. Purpose

OperationalNotification is a **platform capability** that emits **in‑app notifications** when an operational state change requires:

- **Attention** (someone should notice and potentially act)
- **Feedback** (someone should know the outcome)
- **Awareness** (FYI that something important happened)
- **Alert** (exceptional condition worth reviewing)

OperationalNotification helps humans coordinate, but **does not participate in business logic**.

---

## 2. Scope & Boundaries

### In Scope (Operational)
- Notifications generated by POS operational workflows (Sale, CashSession, Inventory-related ops signals)
- Role-based recipients (e.g., Manager/Admin) and actor-based recipients (requester)
- In‑app inbox + unread badge
- Idempotent creation (safe under retries/offline replay)

### Explicitly Out of Scope (Not OperationalNotification)
- Subscription reminders, billing warnings, promotions, announcements
- Email/SMS/push delivery
- Escalation policies (e.g., “if not approved in 5 minutes…”)
- Assignment/claiming of tasks (“this manager owns it”)
- Workflow enforcement (“must approve before X”)

---

## 3. Principles (Non‑Negotiable)

1. **Signals, not tasks**  
   Notifications inform. They do not assign ownership or guarantee action.

2. **Best‑effort**  
   Business truth must remain correct even if notification creation fails.

3. **State is authority**  
   UI actions (approve/reject) must re-check current state, not trust notification freshness.

4. **Idempotent & replay-safe**  
   Notifications must not duplicate under retries, offline sync replay, or double events.

---

## 4. Trigger Model

A valid OperationalNotification trigger must be:
- a **business state transition** (not a read or derived calculation)
- creates a **waiting/awareness gap**
- does not affect correctness if missed

Trigger categories:
- **Waiting-for-human** (strongest): e.g., `VOID_PENDING`
- **Outcome feedback**: e.g., `VOID_APPROVED`, `VOID_REJECTED`
- **Operational awareness**: e.g., `CASH_SESSION_CLOSED`
- **Exception alert**: e.g., “cash session closed with variance” (March: no thresholding; humans evaluate)

---

## 5. Recipient Model

Recipients are computed by **operational responsibility**, not hierarchy.

Recipient strategies:
1. **Approver pool** (role/capability-based)  
   “All users who can perform this action in this branch.”

2. **Requester** (actor-based)  
   “The user who initiated the request.”

3. **Oversight roles** (rare)  
   “Admins/owners for alerts.”

---

## 6. Baseline Use Cases (Capstone 1)

### ON-01: Notify Approvers — Void Request Pending
**Trigger:** Sale transitions to `VOID_PENDING` (Void requested)  
**Intent:** Attention  
**Recipients:** All users with `VOID_APPROVE` permission in `(tenant_id, branch_id)` (typically Manager + Admin)  
**UI Deep Link:** Void request detail / sale detail  
**Notes:**  
- This does not start reversal. Reversal occurs only after approval.
- Multiple approvers may see the same notification; only one approval may succeed.

---

### ON-02: Notify Requester — Void Approved
**Trigger:** Sale transitions to `VOIDED` (Void approved)  
**Intent:** Feedback  
**Recipients:** The user who requested the void  
**UI Deep Link:** Sale detail / receipt view showing VOIDED  
**Notes:**  
- If approver clicks “Approve” again later, it is a no-op (“Already resolved”).

---

### ON-03: Notify Requester — Void Rejected
**Trigger:** Void request transitions to rejected; Sale returns to `FINALIZED`  
**Intent:** Feedback  
**Recipients:** The user who requested the void  
**UI Deep Link:** Sale detail showing “Rejected” reason if provided

---

### ON-04: Notify Managers — Cash Session Closed (Optional Baseline)
**Trigger:** CashSession transitions to `CLOSED`  
**Intent:** Awareness  
**Recipients:** Users eligible for `cashSession.z.view` in branch  
**UI Deep Link:** Z Report / Cash session summary  
**Notes:**  
- This is informational; no action required.
- Include variance values in the notification body so humans can evaluate significance.

---

---

## 7. Delivery Channel (In‑App Only)

OperationalNotification is delivered via:
- **In‑app notification inbox**
- **Unread badge/count** per user

No external channels are implemented in Capstone 1.

---

## 8. Data Model (Suggested Minimal)

### operational_notifications
- id (uuid)
- tenant_id, branch_id
- type (enum)
- subject_type (sale, cash_session, attendance, …)
- subject_id
- title, body (short)
- created_at
- dedupe_key (string)

### operational_notification_recipients
- notification_id
- recipient_user_id
- read_at (nullable)

---

## 9. Idempotency & De‑duplication (Required)

Each notification type must generate a deterministic `dedupe_key`, for example:
- `VOID_APPROVAL_NEEDED:{branch_id}:{sale_id}`
- `VOID_APPROVED:{branch_id}:{sale_id}`
- `VOID_REJECTED:{branch_id}:{sale_id}`
- `CASH_SESSION_CLOSED:{branch_id}:{cash_session_id}`

Constraint recommendation:
- Unique `(tenant_id, dedupe_key)`

This ensures safe behavior under:
- retries
- offline sync replay
- duplicated events

---

## 10. Security & Access Control

- Recipients must be computed using existing RBAC rules.
- Users can only see notifications for tenants/branches they have access to.
- Notifications must not leak sensitive information across tenants.

---

## 11. HR / Attendance (Future, In Scope for OperationalNotification)

OperationalNotification is expected to later include HR operational signals such as:
- late check-in
- missing check-out
- attendance correction requested
- manager override required

These are **not implemented in Capstone 1**, but the module name is chosen to support them.

---

# End of Document
